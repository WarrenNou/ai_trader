<!DOCTYPE html>
<html>
<head>
    <title>Trading Bot Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .card { margin-bottom: 20px; }
        #log-container { 
            height: 300px; 
            overflow-y: auto; 
            background-color: #f8f9fa; 
            padding: 10px;
            font-family: monospace;
        }
        .log-entry { margin-bottom: 5px; }
        .positive { color: green; }
        .negative { color: red; }
        .neutral { color: blue; }
        .bot-controls { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">Trading Bot Dashboard</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Crypto Bot Status</h5>
                    </div>
                    <div class="card-body">
                        <p>Status: <span id="crypto-status">Idle</span></p>
                        <p>Last Started: <span id="crypto-last-started">Never</span></p>
                        <div class="btn-group bot-controls" role="group">
                            <button id="start-crypto-bot" class="btn btn-primary" onclick="controlBot('start', 'crypto')">Start Bot</button>
                            <button id="pause-crypto-bot" class="btn btn-warning" onclick="controlBot('pause', 'crypto')" disabled>Pause Bot</button>
                            <button id="stop-crypto-bot" class="btn btn-danger" onclick="controlBot('stop', 'crypto')" disabled>Stop Bot</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Stock Bot Status</h5>
                    </div>
                    <div class="card-body">
                        <p>Status: <span id="stock-status">Idle</span></p>
                        <p>Last Started: <span id="stock-last-started">Never</span></p>
                        <div class="btn-group bot-controls" role="group">
                            <button id="start-stock-bot" class="btn btn-primary" onclick="controlBot('start', 'stock')">Start Bot</button>
                            <button id="pause-stock-bot" class="btn btn-warning" onclick="controlBot('pause', 'stock')" disabled>Pause Bot</button>
                            <button id="stop-stock-bot" class="btn btn-danger" onclick="controlBot('stop', 'stock')" disabled>Stop Bot</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5>Portfolio Summary</h5>
                    </div>
                    <div class="card-body">
                        <div id="portfolio-summary">
                            <p>Cash: <span id="cash-value">$0.00</span></p>
                            <p>Equity: <span id="equity-value">$0.00</span></p>
                            <p>Total Value: <span id="total-value">$0.00</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Recent Trades</h5>
            </div>
            <div class="card-body">
                <div id="recent-trades">No trades yet</div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>Bot Logs</h5>
            </div>
            <div class="card-body">
                <div id="log-container"></div>
            </div>
        </div>
    </div>

    <script>
        // Function to control bots
        function controlBot(action, botType) {
            fetch(`/${action}/${botType}`)
                .then(response => response.text())
                .then(data => {
                    addLogEntry(data);
                    updateStatus();
                })
                .catch(error => {
                    addLogEntry(`Error: ${error}`, 'negative');
                });
        }

        // Function to add log entry
        function addLogEntry(message, type = 'neutral') {
            const logContainer = document.getElementById('log-container');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // Update UI based on bot status
        function updateButtonStates(botType, status) {
            const startBtn = document.getElementById(`start-${botType}-bot`);
            const pauseBtn = document.getElementById(`pause-${botType}-bot`);
            const stopBtn = document.getElementById(`stop-${botType}-bot`);
            
            if (status === 'Running') {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;
                startBtn.textContent = 'Start Bot';
            } else if (status === 'Paused') {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = false;
                startBtn.textContent = 'Resume Bot';
            } else { // Stopped or Idle
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
                startBtn.textContent = 'Start Bot';
            }
        }

        // Fetch bot status periodically
        function updateStatus() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => {
                    // Update crypto bot status
                    document.getElementById('crypto-status').textContent = data.crypto_status;
                    updateButtonStates('crypto', data.crypto_status);
                    
                    // Update stock bot status
                    document.getElementById('stock-status').textContent = data.stock_status;
                    updateButtonStates('stock', data.stock_status);
                    
                    // Update last started times if available
                    if (data.crypto_last_started) {
                        document.getElementById('crypto-last-started').textContent = 
                            new Date(data.crypto_last_started).toLocaleString();
                    }
                    
                    if (data.stock_last_started) {
                        document.getElementById('stock-last-started').textContent = 
                            new Date(data.stock_last_started).toLocaleString();
                    }
                    
                    // Update portfolio summary
                    if (data.portfolio) {
                        document.getElementById('cash-value').textContent = `$${data.portfolio.cash.toFixed(2)}`;
                        document.getElementById('equity-value').textContent = `$${data.portfolio.equity.toFixed(2)}`;
                        document.getElementById('total-value').textContent = `$${data.portfolio.total_value.toFixed(2)}`;
                    }
                    
                    // Update trades
                    if (data.trades && data.trades.length > 0) {
                        let tradesHtml = '<table class="table table-striped">';
                        tradesHtml += '<thead><tr><th>Time</th><th>Bot</th><th>Symbol</th><th>Action</th><th>Quantity</th><th>Price</th><th>Sentiment</th></tr></thead>';
                        tradesHtml += '<tbody>';
                        
                        data.trades.forEach(trade => {
                            tradesHtml += `<tr>
                                <td>${new Date(trade.time).toLocaleString()}</td>
                                <td>${trade.bot_type}</td>
                                <td>${trade.symbol}</td>
                                <td>${trade.action}</td>
                                <td>${trade.quantity}</td>
                                <td>$${trade.price.toFixed(2)}</td>
                                <td class="${trade.sentiment}">${trade.sentiment}</td>
                            </tr>`;
                        });
                        
                        tradesHtml += '</tbody></table>';
                        document.getElementById('recent-trades').innerHTML = tradesHtml;
                    }
                    
                    // Update logs
                    if (data.logs && data.logs.length > 0) {
                        // Clear existing logs first to avoid duplicates
                        document.getElementById('log-container').innerHTML = '';
                        
                        data.logs.forEach(log => {
                            addLogEntry(log.message, log.type);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                });
        }

        // Update status every 5 seconds
        setInterval(updateStatus, 5000);
        updateStatus(); // Initial update
    </script>
</body>
</html>
